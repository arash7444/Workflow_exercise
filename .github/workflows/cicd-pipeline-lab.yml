# PROVIDED CODE - DO NOT MODIFY
name: Data Pipeline CI/CD

# ==================================================
# SECTION 1: WORKFLOW TRIGGERS
# ==================================================

### PRACTICE CHALLENGE 1 ###
# TASK: Configure workflow triggers to run on pushes to main branch and pull requests 
# targeting main branch. Add path filtering to only trigger when files in 'src/' or 'tests/' 
# directories change.
# YOUR CODE HERE

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - ".github/workflows/cicd-pipeline-lab.yml"
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - ".github/workflows/cicd-pipeline-lab.yml"

# ==================================================
# SECTION 2: BUILD AND TEST JOB
# ==================================================

jobs:
  ### PRACTICE CHALLENGE 2 ###
  # TASK: Create a build job that sets up Python 3.9, installs requirements from requirements.txt, 
  # and runs pytest with coverage reporting. The job should fail if tests don't pass.
  # YOUR CODE HERE
  
  build-and-test:
    # Add your build job configuration here
    runs-on: ubuntu-latest # specify runner environment
    
    steps:
    # Add steps for:
    # 1. Checkout code
    # 2. Set up Python 3.9 with pip caching
    # 3. Install dependencies from requirements.txt
    # 4. Run pytest with coverage reporting
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage
        env:
          PYTHONPATH: ${{ github.workspace }} # i need this to find the src folder in github workspace
        run: pytest --cov=src --cov-report=term-missing


# ==================================================
# SECTION 3: DOCKER BUILD AND DEPLOY
# ==================================================

  ### PRACTICE CHALLENGE 3 ###
  # TASK: Add Docker build and push steps that create an image tagged with both 'latest' 
  # and the Git commit SHA, then push to Docker Hub or GitHub Container Registry.
  # YOUR CODE HERE

  docker-build:
    needs: build-and-test
    runs-on: ubuntu-latest


    # Add steps for:
    # 1. Checkout code  
    # 2. Set up Docker Buildx
    # 3. Login to container registry
    # 4. Build and push Docker image with multiple tags
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
              ${{ secrets.DOCKER_USERNAME }}/data-pipeline:latest
              ${{ secrets.DOCKER_USERNAME }}/data-pipeline:${{ github.sha }}